<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.js" integrity="sha512-eSeh0V+8U3qoxFnK3KgBsM69hrMOGMBy3CNxq/T4BArsSQJfKVsKb5joMqIPrNMjRQSTl4xG8oJRpgU2o9I7HQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css" integrity="sha512-yVvxUQV0QESBt1SyZbNJMAwyKvFTLMyXSyBHDO4BG5t7k/Lw34tyqlSDlKIrIENIzCl+RVUNjmCPG+V/GMesRw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 1500px;
            margin: 0 auto;
            overflow-x: auto;
        }
        h2 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: auto;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="file"], input[type="text"], input[type="email"] {
            width: 100%;
            box-sizing: border-box;
        }
        .form-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: calc(100% - 10px);
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 4px;
        }
        .form-group button:hover {
            background-color: #0056b3;
        }
        .delete-button {
            background-color: #dc3545;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        .product-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .product-group select,
        .product-group input {
            flex: 1;
        }
        .product-group button {
            flex-shrink: 0;
            background-color: #dc3545;
            color: white;
        }
        .product-group button:hover {
            background-color: #c82333;
        }
        .product-group input[type="file"] {
            flex: 2;
        }
        .urgent {
            background-color: red !important;
            color: white;
        }
        .collected {
    background-color: green;
    color: white;
}

.not-collected {
    background-color: orange;
    color: white;
}
.header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 20px;
    }


        .logout-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 4px;
        }
        .logout-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Admin Dashboard</h2>
        <div class="header">
            <button class="logout-button" onclick="logout()">Logout</button>
        </div>
        
        <div class="form-container">
            <form id="newOrderForm">
                <div class="form-group">
                    <label for="newUsername">Username:</label>
                    <input type="text" id="newUsername">
                </div>
                <div class="form-group">
                    <label for="newName">Name:</label>
                    <input type="text" id="newName">
                </div>
                <div class="form-group">
                    <label for="newBusinessUnit">Business Unit (BU):</label>
                    <select id="newBusinessUnit">
                        <option value="" selected>Select a Business Unit</option>
                        <option value="B2C">B2C</option>
                        <option value="B2B">B2B</option>
                        <option value="B2O">B2O</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newGender">Gender:</label>
                    <select id="newGender">
                        <option value="None" selected>None</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newAge">Age:</label>
                    <input type="number" id="newAge" min="0">
                </div>
                <div class="form-group">
                    <label for="newPhone">Phone Number:</label>
                    <input type="text" id="newPhone">
                </div>
                <div class="form-group">
                    <label for="newEmail">Email:</label>
                    <input type="email" id="newEmail">
                </div>
                <div class="form-group">
                    <label for="newAddress">Address:</label>
                    <input type="text" id="newAddress">
                </div>
                <div class="form-group">
                    <label for="reference">Reference:</label>
                    <select id="reference">
                        <option value="" selected>Select a reference</option>
                        <option value="google_ads">Google Ads</option>
                        <option value="instagram">Instagram</option>
                        <option value="friends_family">Friends and Family</option>
                        <option value="others">Others</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="zone">Zone:</label>
                    <select id="zone">
                        <option value="" selected>Select a Zone</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Requested Products:</label>
                    <div id="requestedProductsContainer">
                        <div class="product-group">
                            <select class="product-select chosen-select">
                                <option value="" selected>Select a product</option>
                                <option value="Laptop">Laptop</option>
                                <option value="Television">Television</option>
                                <option value="Phone">Phone</option>
                                <option value="Battery">Battery</option>
                                <option value="Refrigerator">Refrigerator</option>
                            </select>
                            <input type="number" class="product-quantity" placeholder="Quantity" min="1">
                            <button type="button" onclick="removeProduct(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" onclick="addProduct()">Add Another Product</button>
                </div>
                <div class="form-group">
                    <label for="poaMode">POA/Mode:</label>
                    <select id="poaMode">
                        <option value="" selected>Select POA/Mode</option>
                        <option value="EV">EV</option>
                        <option value="Tempo">Tempo</option>
                        <option value="Train">Train</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productFiles">Upload Product Files:</label>
                    <input type="file" id="productFiles" multiple>
                </div>
                <div class="form-group">
                    <label for="uploadPicture">Upload Picture:</label>
                    <input type="file" id="uploadPicture" multiple>
                </div>
                <div class="form-group">
                    <label for="newCertificate">Upload Certificate:</label>
                    <input type="file" id="newCertificate">
                </div>
                <div class="form-group">
                    <label for="requestStatus">Request Status:</label>
                    <select id="requestStatus">
                        <option value="" selected>Select Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="urgencyLevel">Urgency Level:</label>
                    <select id="urgencyLevel">
                        <option value="" selected>Select Urgency Level</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" id="submitOrderBtn" onclick="addOrder()">
                        <i id="spinner" class="fas fa-spinner fa-spin" style="display: none; margin-right: 8px;"></i>
                        <span id="buttonText">Submit Order</span>
                    </button>
                </div>
            </form>
        </div>
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Name</th>
                    <th>BU</th>
                    <th>Gender</th>
                    <th>Age</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Zone</th>
                    <th>Requested Products</th>
                    <th>POA/Mode</th>
                    <th>Product Files</th>
                    <th>Picture</th>
                    <th>Certificate</th>
                    <th>Request Status</th>
                    <th>Urgency Level</th>
                    <th>Collection Status</th>
                    <th>Allocated Pickup Date</th>
                    <th>Actual Pickup Date</th>
                    <th>Recieved Products</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();  // Load existing orders when the page loads

            // Initialize chosen selects
            $(".chosen-select").chosen();
        });
        
        function logout() {
            fetch('http://localhost:5000/logout', { 
                method: 'POST',
                credentials: 'include',
            })
            .then(response => {
                if (response.ok) {
                    localStorage.clear();
                    alert("Logged out successfully!");
                    window.location.href = 'index.html';
                } else {
                    alert("Failed to log out. Please try again.");
                }
            })
            .catch(error => {
                console.error('Error logging out:', error);
                alert("An error occurred while logging out.");
            });
        }

        function addProduct() {
            var productGroup = document.createElement('div');
            productGroup.className = 'product-group';
            productGroup.innerHTML = `
                <select class="product-select chosen-select">
                    <option value="" selected>Select a product</option>
                    <option value="Laptop">Laptop</option>
                    <option value="Television">Television</option>
                    <option value="Phone">Phone</option>
                    <option value="Battery">Battery</option>
                    <option value="Refrigerator">Refrigerator</option>
                </select>
                <input type="number" class="product-quantity" placeholder="Quantity" min="1">
                <button type="button" onclick="removeProduct(this)">Remove</button>
            `;
            document.getElementById('requestedProductsContainer').appendChild(productGroup);
            $(".chosen-select").chosen();
        }

        function removeProduct(button) {
            var productGroup = button.parentNode;
            productGroup.parentNode.removeChild(productGroup);
        }

        var products = [];
        function getRequestedProducts() {
            // Function to get the requested products dynamically
            var productSelects = document.getElementsByClassName('product-select');
            var productQuantities = document.getElementsByClassName('product-quantity');
            for (var i = 0; i < productSelects.length; i++) {
                var product = productSelects[i].value;
                var quantity = productQuantities[i].value;
                if (product && quantity) {
                    products.push({ product: product, quantity: quantity });
                }
            }
            return products;
        }

        async function uploadFilesToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'ml_default'); // Replace with your Cloudinary upload preset
            // formData.append('resource_type', 'raw');  // Explicitly set resource type to 'raw'

            try {
                const response = await fetch('https://api.cloudinary.com/v1_1/dl8c4ux5w/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                console.log("Uploaded URL: "+ data.secure_url);
                return data.secure_url;  // Return the uploaded file's URL
            } catch (error) {
                console.error('Error uploading file to Cloudinary:', error);
                alert('Failed to upload file to Cloudinary.');
            }
        }

        async function addOrder() {
            const submitButton = document.getElementById('submitOrderBtn');
            const spinner = document.getElementById('spinner');
            const buttonText = document.getElementById('buttonText');

            spinner.style.display = 'inline-block';  // Show spinner
            buttonText.innerText = 'Submitting your order...';  // Update button text
            submitButton.disabled = true;  // Disable the button to prevent multiple clicks

            try {
                const productFilesInput = document.getElementById('productFiles');
                const uploadPictureInput = document.getElementById('uploadPicture');
                const certificateInput = document.getElementById('newCertificate');

                // Collect Product Files URLs
                const productFilesURLs = [];
                for (const file of productFilesInput.files) {
                    const url = await uploadFilesToCloudinary(file);
                    if (url) productFilesURLs.push(url);
                }

                // Collect Picture URLs
                const pictureURLs = [];
                for (const file of uploadPictureInput.files) {
                    const url = await uploadFilesToCloudinary(file);
                    if (url) pictureURLs.push(url);
                }

                // Collect Certificate URL (assuming only one certificate file)
                let certificateURL = '';
                if (certificateInput.files.length > 0) {
                    certificateURL = await uploadFilesToCloudinary(certificateInput.files[0]);
                } 

                var products = getRequestedProducts();
                var formdata = {
                    username: document.getElementById('newUsername').value,
                    name: document.getElementById('newName').value,
                    businessUnit: document.getElementById('newBusinessUnit').value,
                    gender: document.getElementById('newGender').value,
                    age: document.getElementById('newAge').value,
                    phone: document.getElementById('newPhone').value,
                    email: document.getElementById('newEmail').value,
                    address: document.getElementById('newAddress').value,  
                    reference: document.getElementById('reference').value,  
                    zone: document.getElementById('zone').value,
                    requestedProducts: products,  
                    poaMode: document.getElementById('poaMode').value,
                    productFiles: productFilesURLs, 
                    picture: pictureURLs,  
                    certificate: certificateURL,  
                    requestStatus: document.getElementById('requestStatus').value,
                    urgencyLevel: document.getElementById('urgencyLevel').value,
                }

                const response = await fetch('http://localhost:5000/addProduct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formdata)
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Order submitted successfully!');
                    console.log('Order data:', data);
                    document.getElementById('newOrderForm').reset();
                    $(".chosen-select").trigger("chosen:updated");  // Re-initialize chosen select elements if needed
                    loadOrders();
                } 
                else {
                    alert('Failed to submit order: ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting order:', error);
                alert('An error occurred while submitting the order.');
            } finally {
                // Hide loading spinner and reset button text
                spinner.style.display = 'none';  // Hide spinner
                buttonText.innerText = 'Submit Order';  // Reset button text
                submitButton.disabled = false;  // Enable the button again
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch('http://localhost:5000/getAllProducts');
                const orders = await response.json();

                if (response.ok) {
                    displayOrders(orders);  // Display the orders in the table
                } else {
                    console.error('Failed to fetch orders:', orders.message);
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        async function deleteOrder(orderId) {
            try {
                const response = await fetch(`http://localhost:5000/deleteProduct/${orderId}`, {
                    method: 'DELETE',
                });

                const responseData = await response.json();
                if (response.ok) {
                    alert('Order deleted successfully!');
                    loadOrders();  // Reload orders to refresh the table
                } else {
                    alert('Failed to delete order: ' + responseData.message);
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('An error occurred while deleting the order.');
            }
        }

        function displayOrders(orders) {
            const ordersTable = document.getElementById('ordersTable').getElementsByTagName('tbody')[0];
            ordersTable.innerHTML = '';  // Clear existing table rows

            orders.forEach(order => {
                const newRow = ordersTable.insertRow();
                newRow.insertCell(0).innerText = order.username;
                newRow.insertCell(1).innerText = order.name;
                newRow.insertCell(2).innerText = order.businessUnit;
                newRow.insertCell(3).innerText = order.gender;
                newRow.insertCell(4).innerText = order.age;
                newRow.insertCell(5).innerText = order.phone;
                newRow.insertCell(6).innerText = order.email;
                newRow.insertCell(7).innerText = order.address;
                newRow.insertCell(8).innerText = order.zone;
                newRow.insertCell(9).innerText = order.requestedProducts;
                newRow.insertCell(10).innerText = order.poaMode;
                
                const linkColor = order.urgencyLevel === "Yes" ? "white" : "#007bff";

                const productFilesCell = newRow.insertCell(11);
                if (Array.isArray(order.productFiles) && order.productFiles.length > 0) {
                    order.productFiles.forEach((file, index) => {
                        const link = document.createElement('a');
                        link.href = file;
                        link.target = '_blank';  // Open in new tab
                        link.innerText = `File ${index + 1}`;  // Label as "File 1", "File 2", etc.
                        link.style.color = linkColor;  // Set link color based on urgency
                        productFilesCell.appendChild(link);
                        productFilesCell.appendChild(document.createElement('br'));  // Line break for each file
                    });
                } else {
                    productFilesCell.innerText = 'No Files';
                }

                const pictureCell = newRow.insertCell(12);
                if (Array.isArray(order.picture) && order.picture.length > 0) {
                    order.picture.forEach((pic, index) => {
                        const link = document.createElement('a');
                        link.href = pic;
                        link.target = '_blank';  // Open in new tab
                        link.innerText = `Image ${index + 1}`;  // Label as "Picture 1", "Picture 2", etc.
                        link.style.color = linkColor;  // Set link color based on urgency
                        pictureCell.appendChild(link);
                        pictureCell.appendChild(document.createElement('br'));  // Line break for each picture
                    });
                } else {
                    pictureCell.innerText = 'No Pictures';
                }

                const certificateCell = newRow.insertCell(13);
                if (order.certificate) {
                    const link = document.createElement('a');
                    link.href = order.certificate;
                    link.target = '_blank';  // Open in new tab
                    link.innerText = 'Certificate';  // Label as "Certificate"
                    link.style.color = linkColor;  // Set link color based on urgency
                    certificateCell.appendChild(link);
                } else {
                    certificateCell.innerText = 'No Certificate';
                }
                newRow.insertCell(14).innerText = order.requestStatus;
                newRow.insertCell(15).innerText = order.urgencyLevel;
                newRow.insertCell(16).innerHTML = `<span class="${order.collectionStatus === 'Collected' ? 'collected' : 'not-collected'}">${order.collectionStatus}</span>`;
                newRow.insertCell(17).innerText = order.allocatedPickupDate || "";
                newRow.insertCell(18).innerText = order.actualPickupDate || "";
                newRow.insertCell(19).innerText = order.receivedProducts | "";

                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Delete';
                deleteButton.className = 'delete-button';
                deleteButton.onclick = function() {
                    deleteOrder(order._id);  // Call deleteOrder function to delete the order
                };
                newRow.insertCell(20).appendChild(deleteButton);

                if (order.urgencyLevel === "Yes" && order.collectionStatus !== 'Collected') {
                    newRow.classList.add('urgent');
                }

                if (order.collectionStatus === 'Collected') {
                    newRow.classList.remove('urgent');
                }
            });
        }
        
    </script>
</body>
</html>
