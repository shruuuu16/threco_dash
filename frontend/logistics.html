<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 95%;
            max-width: 1200px;
            margin: 20px;
            overflow-x: auto; /* Allow horizontal scrolling */
        }

        h1 {
            text-align: center;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: auto; /* Adjust width based on content */
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            max-width: none; /* No fixed maximum width */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
            white-space: nowrap; /* Prevent text wrapping */
        }

        th {
            background-color: #007bff;
            color: white;
        }

        .upload-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .upload-btn:hover {
            background-color: #0056b3;
        }

        input[type="text"], select {
            width: auto; /* Allow input and select to adjust based on content */
            max-width: 100%; /* Ensure they do not exceed their container */
        }

        .urgent {
    background-color: #ffcccc; /* Light red background for urgent orders */
}

.urgent-collected {
    background-color: #ffffff; /* White background when collected */
}

/* Add this new style for text color */
.urgent td {
    color: red; /* Red text for urgent orders */
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Logistics Dashboard</h1>
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Phone Number</th>
                    <th>Zone</th>
                    <th>POA/Mode</th>
                    <th>Allocated Pickup Date</th>
                    <th>Actual Pickup Date</th>
                    <th>Collection Status</th>
                    <th>Collected By</th>
                    <th>Received Products</th>
                    <th>Doorstep Picture</th>
                    <th>Pickup Sheet Picture</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated dynamically -->
            </tbody>
        </table>
    </div>
    <script>
       document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed.');

    if (!localStorage.getItem('logisticsLoggedIn')) {
        alert('Please log in first.');
        window.location.href = 'logistics.login.html';
        return;
    }

    const ordersTable = document.getElementById('ordersTable').getElementsByTagName('tbody')[0];

    function renderOrders() {
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    console.log('All orders:', orders);

    // Filter for approved orders
    orders = orders.filter(order => order.requestStatus === 'Approved');
    console.log('Approved orders:', orders);

    ordersTable.innerHTML = '';

    // Sort orders: urgent and not collected orders on top
    orders.sort((a, b) => {
        if (a.urgencyLevel === "Yes" && a.collectionStatus !== 'Collected' && (b.urgencyLevel !== "Yes" || b.collectionStatus === 'Collected')) return -1;
        if ((a.urgencyLevel !== "Yes" || a.collectionStatus === 'Collected') && b.urgencyLevel === "Yes" && b.collectionStatus !== 'Collected') return 1;
        return 0;
    });

    orders.forEach(order => {
        // Apply urgent class if order is urgent and not collected
        const isUrgent = order.urgencyLevel === "Yes" && order.collectionStatus !== 'Collected' ? 'urgent' : '';
        const collectedClass = order.collectionStatus === 'Collected' ? 'urgent-collected' : '';

        const row = ordersTable.insertRow();
        row.className = `${isUrgent} ${collectedClass}`;

        row.innerHTML = `
            <td>${order.name}</td>
            <td>${order.address}</td>
            <td>${order.phone || ''}</td>
            <td>${order.zone || ''}</td>
            <td>${order.poaMode || ''}</td>
            <td>
                <input type="date" value="${order.allocatedPickupDate || ''}" data-id="${order.id}" class="allocatedPickupDate">
            </td>
            <td>
                <input type="date" value="${order.actualPickupDate || ''}" data-id="${order.id}" class="actualPickupDate">
            </td>
            <td>
                <select data-id="${order.id}" class="collectionStatus">
                    <option value="Not Collected" ${order.collectionStatus === 'Not Collected' ? 'selected' : ''}>Not Collected</option>
                    <option value="Collected" ${order.collectionStatus === 'Collected' ? 'selected' : ''}>Collected</option>
                </select>
            </td>
            <td><input type="text" value="${order.collectedBy || ''}" data-id="${order.id}" class="collectedBy"></td>
            <td><input type="text" value="${order.receivedProducts || ''}" data-id="${order.id}" class="receivedProducts" placeholder="Enter received products"></td>
            <td>
                <input type="file" accept="image/png, image/jpeg" data-id="${order.id}" class="pictureInput">
                <button class="upload-btn" data-id="${order.id}">Upload</button>
            </td>
            <td>
                <input type="file" accept="image/png, image/jpeg" data-id="${order.id}" class="pickupSheetInput">
                <button class="upload-btn" data-id="${order.id}">Upload Pickup Sheet</button>
            </td>
            <td><button data-id="${order.id}" class="save-btn">Save</button></td>
        `;
    });
}

    function saveOrderChanges(orderId, changes) {
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    const index = orders.findIndex(o => o.id === orderId);

    if (index > -1) {
        // Ensure that when an order is collected, it is no longer marked as urgent
        if (changes.collectionStatus === 'Collected') {
            changes.urgencyLevel = "No"; // Reset urgency when collected
        }

        orders[index] = { ...orders[index], ...changes };
        localStorage.setItem('orders', JSON.stringify(orders));
        alert('Order updated successfully!');
        renderOrders(); // Re-render orders to update the display
    }
}

    // Listen for changes in inputs or select elements
    ordersTable.addEventListener('change', function(event) {
        const target = event.target;
        if (target.tagName === 'SELECT' || target.tagName === 'INPUT') {
            const orderId = target.getAttribute('data-id');
            console.log('Change detected for order ID:', orderId);

            const collectionStatus = document.querySelector(`select.collectionStatus[data-id="${orderId}"]`).value;
            const collectedBy = document.querySelector(`input.collectedBy[data-id="${orderId}"]`).value;
            const receivedProducts = document.querySelector(`input.receivedProducts[data-id="${orderId}"]`).value;
            const allocatedPickupDate = document.querySelector(`input.allocatedPickupDate[data-id="${orderId}"]`).value;
            const actualPickupDate = document.querySelector(`input.actualPickupDate[data-id="${orderId}"]`).value;

            saveOrderChanges(orderId, {
                collectionStatus,
                collectedBy,
                receivedProducts,
                allocatedPickupDate,
                actualPickupDate
            });
        }
    });

    // Listen for save or upload button clicks
    ordersTable.addEventListener('click', function(event) {
        if (event.target.classList.contains('save-btn')) {
            const orderId = event.target.getAttribute('data-id');
            console.log('Save button clicked for order ID:', orderId);

            const collectionStatus = document.querySelector(`select.collectionStatus[data-id="${orderId}"]`).value;
            const collectedBy = document.querySelector(`input.collectedBy[data-id="${orderId}"]`).value;
            const receivedProducts = document.querySelector(`input.receivedProducts[data-id="${orderId}"]`).value;
            const allocatedPickupDate = document.querySelector(`input.allocatedPickupDate[data-id="${orderId}"]`).value;
            const actualPickupDate = document.querySelector(`input.actualPickupDate[data-id="${orderId}"]`).value;

            saveOrderChanges(orderId, {
                collectionStatus,
                collectedBy,
                receivedProducts,
                allocatedPickupDate,
                actualPickupDate
            });
        }

        if (event.target.classList.contains('upload-btn')) {
            const orderId = event.target.getAttribute('data-id');
            console.log('Upload button clicked for order ID:', orderId);

            const pictureInput = document.querySelector(`input.pictureInput[data-id="${orderId}"]`);
            const pickupSheetInput = document.querySelector(`input.pickupSheetInput[data-id="${orderId}"]`);
            const pictureFile = pictureInput.files[0];
            const pickupSheetFile = pickupSheetInput.files[0];

            if (pictureFile || pickupSheetFile) {
                const formData = new FormData();
                if (pictureFile) formData.append('picture', pictureFile);
                if (pickupSheetFile) formData.append('pickupSheet', pickupSheetFile);
                formData.append('orderId', orderId);

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                }).then(response => response.json())
                  .then(data => {
                      alert(data.message);
                  })
                  .catch(error => {
                      console.error('Error:', error);
                  });
            } else {
                alert('Please select a file to upload.');
            }
        }
    });

    renderOrders(); // Initial render
});

    
    </script>    
</body>
</html>
